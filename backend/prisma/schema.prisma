// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Region {
  CENTRAL
  EAST
  NORTH
  NORTH_EAST
  WEST
  UNKNOWN
}

// User Management
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole @default(CLIENT)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("users")
}

enum UserRole {
  CLIENT
  ADMIN
}

model Subzone {
  id           String   @id                    // stable URA subzone code/slug (e.g., "TAMPINES_EAST")
  name         String   @db.VarChar(120)       // display name (e.g., "Tampines East")
  region       Region   @default(UNKNOWN)
  geomGeoJSON  Json?                           // optional; polygons can also be client-only GeoJSON

  // 1:1 simplified population snapshot (latest)
  population   Population?
  populationId String?     @unique

  // Relations to existing models
  demand          Demand?
  supply          Supply?
  accessibility   Accessibility?
  scores          HawkerOpportunityScore[]

  // bookkeeping
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([name])
  @@index([region])
}

model Population {
  subzoneId   String  @id
  subzoneName String  @db.VarChar(120)
  year        Int
  total       Int

  subzone     Subzone @relation(fields: [subzoneId], references: [id], onDelete: Cascade)

  @@index([year])
  @@index([total])
}

model PopulationUnmatched {
  id         String   @id @default(cuid())
  sourceKey  String   @db.VarChar(200)  // primary key or composite key from the gov dataset
  rawName    String   @db.VarChar(200)
  reason     String?  @db.VarChar(200)
  details    Json?
  createdAt  DateTime @default(now())
}

model DatasetSnapshot {
  id          String   @id @default(cuid())
  kind        String   @db.VarChar(64)     // e.g., "population"
  sourceUrl   String?  @db.VarChar(500)
  versionNote String?  @db.VarChar(200)    // optional semantic/date tag
  startedAt   DateTime @default(now())
  finishedAt  DateTime?
  status      String   @db.VarChar(40)     // "success" | "partial" | "failed"
  meta        Json?

  @@index([kind, startedAt])
}

// Hawker Centre Data
model HawkerCentre {
  id       String @id @default(cuid())
  centreId String @unique
  name     String
  location Json   // GeoJSON point
  capacity Int
  status   String
  createdAt DateTime @default(now())

  @@map("hawker_centres")
}

// MRT Station Data
model MRTStation {
  id        String @id @default(cuid())
  stationId String @unique
  name      String
  location  Json   // GeoJSON point
  lineCount Int
  createdAt DateTime @default(now())

  @@map("mrt_stations")
}

// Bus Stop Data
model BusStop {
  id        String  @id @default(cuid())
  stopCode  String  @unique
  roadName  String
  location  Json    // GeoJSON point
  freqWeight Float
  createdAt DateTime @default(now())

  @@map("bus_stops")
}

// Score Components
model Demand {
  id        String @id @default(cuid())
  subzoneId String @unique
  rawKDE    Float
  zScore    Float
  lambdaD   Float  // Kernel bandwidth
  createdAt DateTime @default(now())

  subzone   Subzone @relation(fields: [subzoneId], references: [id], onDelete: Cascade)

  @@map("demand")
}

model Supply {
  id              String @id @default(cuid())
  subzoneId       String @unique
  rawKDECompeting Float
  zScore          Float
  lambdaS         Float  // Kernel bandwidth
  createdAt       DateTime @default(now())

  subzone         Subzone @relation(fields: [subzoneId], references: [id], onDelete: Cascade)

  @@map("supply")
}

model Accessibility {
  id        String @id @default(cuid())
  subzoneId String @unique
  rawMRTKDE Float
  rawBusKDE Float
  betaMRT   Float
  betaBUS   Float
  lambdaM   Float  // MRT kernel bandwidth
  lambdaB   Float  // Bus kernel bandwidth
  zScore    Float
  createdAt DateTime @default(now())

  subzone   Subzone @relation(fields: [subzoneId], references: [id], onDelete: Cascade)

  @@map("accessibility")
}

// Final Scores
model HawkerOpportunityScore {
  id         String @id @default(cuid())
  subzoneId  String
  H          Float  // Final Hawker Opportunity Score
  zDemand    Float
  zSupply    Float
  zAccess    Float
  wD         Float  // Demand weight
  wS         Float  // Supply weight
  wA         Float  // Accessibility weight
  percentile Float
  snapshotId String
  createdAt  DateTime @default(now())

  subzone    Subzone @relation(fields: [subzoneId], references: [id], onDelete: Cascade)
  snapshot   Snapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@map("hawker_opportunity_scores")
}

// Snapshots and Configuration
model Snapshot {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  notes     String?

  // Relations
  scores    HawkerOpportunityScore[]
  datasets  DatasetVersion[]
  config    KernelConfig?

  @@map("snapshots")
}

model DatasetVersion {
  id           String   @id @default(cuid())
  snapshotId   String
  datasetName  String
  sourceURL    String
  lastUpdated  DateTime
  retrievedAt  DateTime @default(now())
  schemaHash   String

  snapshot     Snapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@map("dataset_versions")
}

model KernelConfig {
  id         String @id @default(cuid())
  kernelType String @default("Gaussian")
  lambdaD    Float
  lambdaS    Float
  lambdaM    Float
  lambdaB    Float
  betaMRT    Float
  betaBUS    Float
  notes      String?
  createdAt  DateTime @default(now())

  snapshot   Snapshot? @relation(fields: [id], references: [id])

  @@map("kernel_configs")
}
